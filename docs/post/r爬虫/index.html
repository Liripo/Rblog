<!DOCTYPE html>
<html lang="Zh-cn">

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>R爬虫 | Liripo</title>
    <link rel="shortcut icon" href="../../image/title.svg" type="image/x-icon">
  <script src="../../fontawesome-free-5.11.2-web/fontawesome-free-5.11.2-web/js/all.js" crossorigin="anonymous"></script>

  <style>
  	:root {
  		--pagecolour: #333333;
  		--maintext: #dddddd;
  		--faded: #888888;
  		--highlight: #6BB0DF;
  		--lowlight: #ba68c8;
	}
  </style>
  <link rel="stylesheet" href="../../css/et_book.css" />
  <link rel="stylesheet" href="../../css/search.css" />
  <link rel="stylesheet" href="../../css/style.css" />
  <link rel="alternate" type="application/rss+xml" href="https://liripo.github.io/index.xml" title="Liripo">
  
  <link rel="stylesheet" href="https://fonts.loli.net/css?family=Tangerine">

  
<meta name="twitter:card" content="summary">
<meta property="og:title" content="R爬虫">




</head>


  <body>
    



    <div class="main-content">
      <nav>
  <ul class="menu">
    
    <li><a href="../../">Home</a></li>
    
    <li><a href="../../about/">About</a></li>
    
    <li><a href="../../post/">Posts</a></li>
    
    <li><a href="../../tags/">Tags</a></li>
    
  </ul>
</nav>

      <div>
  <h1>R爬虫</h1>
  <h3>
    28 Mar 2020
  </h3>
   <h5 id="wc">890 Words|Read in about 2       Min|本文总阅读量<span id="busuanzi_value_page_pv"></span>次</h5>
    </h5>
  <br><br>
</div>


      <main>
        

        <h1 id="heading">静态网页</h1>
<p>简单的静态网页使用rvest包完全可以胜任。</p>
<h1 id="heading-1">动态网页</h1>
<p>需要移动鼠标点击鼠标的则可以使用RSelenium
其作用是用R调用Selenium Server，通过Selenium Server我们可以对网页进行操作，然后爬取操作后的数据，从而进行爬取动态页面。</p>
<h2 id="heading-2">初次使用</h2>
<ul>
<li>java安装</li>
<li><a href="http://npm.taobao.org/mirrors/chromedriver">谷歌驱动</a>安装,由于需要对应谷歌浏览器的版本，所以可以都使用最新的版本。下载,注意chrome驱动一定要和chrome浏览器对应 ,比如我的浏览器83.4109&hellip;. ，查看浏览器版本，点击谷歌浏览器右上【…】—【帮助】–【关于Google Chrome】就可以看到浏览器版本了。然后我就下载83开头的就行。</li>
<li>记得将下载的谷歌驱动与chrome.exe放在一个文件夹下，然后将这个文件夹路径添加至环境变量。如何添加环境变量可自行goole。</li>
<li><a href="https://www.selenium.dev/downloads/">Selenium Standalone Server</a>下载,我下载的是selenium-server-standalone-3.141.59.jar
selenium server使用可以在文件所在目录运行</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">java -jar .<span style="color:#ae81ff">\s</span>elenium-server-standalone-3.141.59.jar
</code></pre></div><p>或者直接在Rstudio中运行</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-R" data-lang="R"><span style="color:#a6e22e">system</span>(<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">java -jar &#34;C:/RSelenium/selenium-server-standalone-3.11.0.jar&#34;&#39;</span>,wait <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>)
</code></pre></div><p><strong>运行结束后勿关闭，最小化即可。</strong></p>
<h1 id="rselenium">RSelenium使用与实例</h1>
<p>爬取<a href="https://biit.cs.ut.ee/gprofiler/gost">富集分析网站</a>示例代码</p>
<p>其中txt前几行如下</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-R" data-lang="R">CESC  <span style="color:#ae81ff">1</span> Cluster0 https<span style="color:#f92672">:</span><span style="color:#f92672">/</span><span style="color:#f92672">/</span>biit.cs.ut.ee<span style="color:#f92672">/</span>gplink<span style="color:#f92672">/</span>l<span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>WPg5kkuQq
CESC  <span style="color:#ae81ff">2</span> Cluster1 https<span style="color:#f92672">:</span><span style="color:#f92672">/</span><span style="color:#f92672">/</span>biit.cs.ut.ee<span style="color:#f92672">/</span>gplink<span style="color:#f92672">/</span>l<span style="color:#f92672">/</span>cN9yKkqzSj
CESC  <span style="color:#ae81ff">3</span> Cluster2 https<span style="color:#f92672">:</span><span style="color:#f92672">/</span><span style="color:#f92672">/</span>biit.cs.ut.ee<span style="color:#f92672">/</span>gplink<span style="color:#f92672">/</span>l<span style="color:#f92672">/</span>WEBiuG<span style="color:#ae81ff">-4</span>S_
</code></pre></div><blockquote>
<p>代码,里面添加了一些无限循环操作。</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-R" data-lang="R"><span style="color:#a6e22e">library</span>(rvest)
<span style="color:#a6e22e">library</span>(RSelenium)
<span style="color:#a6e22e">library</span>(fs)
<span style="color:#a6e22e">library</span>(tidyverse)
<span style="color:#75715e">#连接浏览器</span>
<span style="color:#75715e">#运行server</span>
isempty <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(){
    html <span style="color:#f92672">&lt;-</span> remDr<span style="color:#f92672">$</span><span style="color:#a6e22e">getPageSource</span>()[[1]]
    html <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">read_html</span>(html)
    xpath <span style="color:#f92672">&lt;-</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">/html/body/div/div/div/div[3]/div[3]/div/div/div&#34;</span>
    htmltext <span style="color:#f92672">&lt;-</span> html <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">html_nodes</span>(xpath <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">/html/body/div/div/div/div[3]/div[3]/div/div/div&#34;</span>) <span style="color:#f92672">%&gt;%</span> 
        <span style="color:#a6e22e">html_text</span>(trim <span style="color:#f92672">=</span> T)
    <span style="color:#75715e">#页面没刷新情况</span>
    <span style="color:#a6e22e">if</span>(rlang<span style="color:#f92672">::</span><span style="color:#a6e22e">is_empty</span>(htmltext))<span style="color:#a6e22e">return</span>(<span style="color:#66d9ef">TRUE</span>) 
    <span style="color:#75715e">#没有结果情况</span>
    <span style="color:#a6e22e">if</span>(htmltext <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">No results.&#34;</span>){
        <span style="color:#a6e22e">return</span>(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">No results.&#34;</span>)
    }else{
    boolen <span style="color:#f92672">&lt;-</span> html <span style="color:#f92672">%&gt;%</span> 
        <span style="color:#a6e22e">html_nodes</span>(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">.active+ .tab-button a&#34;</span>) <span style="color:#f92672">%&gt;%</span> 
        rlang<span style="color:#f92672">::</span><span style="color:#a6e22e">is_empty</span>()
    }
}
isempty2 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(){
    html <span style="color:#f92672">&lt;-</span> remDr<span style="color:#f92672">$</span><span style="color:#a6e22e">getPageSource</span>()[[1]]
    html <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">read_html</span>(html)
    boolen <span style="color:#f92672">&lt;-</span> html <span style="color:#f92672">%&gt;%</span> 
        <span style="color:#a6e22e">html_nodes</span>(xpath <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">/html/body/div/div/div/div[3]/div[3]/div/div/div[1]/div[2]/div[2]/div[1]/div/button[1]&#34;</span>) <span style="color:#f92672">%&gt;%</span> 
        rlang<span style="color:#f92672">::</span><span style="color:#a6e22e">is_empty</span>()
}
<span style="color:#75715e">#R中运行selenium server</span>
<span style="color:#a6e22e">system</span>(<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">java -jar &#34;../selenium-server-standalone-3.141.59.jar&#34;&#39;</span>,
       wait <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>)
<span style="color:#75715e">#------打开浏览器，模拟点击</span>
remDr <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">remoteDriver</span>(
    browserName <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">chrome&#34;</span>,
    remoteServerAddr <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">localhost&#34;</span>,
    port <span style="color:#f92672">=</span> <span style="color:#ae81ff">4444L</span>)
remDr<span style="color:#f92672">$</span><span style="color:#a6e22e">open</span>()
txt <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">read_csv</span>(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">clusterurl.csv&#34;</span>,col_names <span style="color:#f92672">=</span> F)
txt <span style="color:#f92672">&lt;-</span> txt <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">separate</span>(X2,sep <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74"> &#34;</span>,into <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">row&#34;</span>,<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">cluster&#34;</span>,<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">url2&#34;</span>))
getgprofiler <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(url){
    tmp <span style="color:#f92672">&lt;-</span> txt <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">filter</span>(url2 <span style="color:#f92672">==</span> url)
    remDr<span style="color:#f92672">$</span><span style="color:#a6e22e">navigate</span>(url)
    <span style="color:#75715e">#沉睡40秒</span>
    <span style="color:#a6e22e">Sys.sleep</span>(<span style="color:#ae81ff">30</span>)
    <span style="color:#75715e">#判断是否加载完全，不完全则一直沉睡,没有限定次数错误退出的情况。</span>
    boolen1 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">isempty</span>()
    <span style="color:#75715e">#还有一种没有显著结果的</span>
    <span style="color:#a6e22e">if</span>(boolen1 <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">No results.&#34;</span>)<span style="color:#a6e22e">return</span>(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">No results.&#34;</span>)
    <span style="color:#a6e22e">while</span>(boolen1){
        remDr<span style="color:#f92672">$</span><span style="color:#a6e22e">navigate</span>(url)
        <span style="color:#a6e22e">Sys.sleep</span>(<span style="color:#ae81ff">20</span>)
        boolen1 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">isempty</span>()
    }
    x <span style="color:#f92672">&lt;-</span> remDr<span style="color:#f92672">$</span><span style="color:#a6e22e">findElement</span>(using <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">css selector&#34;</span>,value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">.active+ .tab-button a&#34;</span>)
    remDr<span style="color:#f92672">$</span><span style="color:#a6e22e">mouseMoveToLocation</span>(webElement<span style="color:#f92672">=</span>x)
    remDr<span style="color:#f92672">$</span><span style="color:#a6e22e">click</span>()
    <span style="color:#a6e22e">Sys.sleep</span>(<span style="color:#ae81ff">5</span>)
    boolen2 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">isempty2</span>()
    <span style="color:#a6e22e">while</span>(boolen2){
        remDr<span style="color:#f92672">$</span><span style="color:#a6e22e">mouseMoveToLocation</span>(webElement<span style="color:#f92672">=</span>x)
        remDr<span style="color:#f92672">$</span><span style="color:#a6e22e">click</span>()
        boolen2 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">isempty2</span>()
    }
    xpath <span style="color:#f92672">&lt;-</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">/html/body/div/div/div/div[3]/div[3]/div/div/div[1]/div[2]/div[2]/div[1]/div/button[1]&#34;</span>
    l <span style="color:#f92672">&lt;-</span> remDr<span style="color:#f92672">$</span><span style="color:#a6e22e">findElement</span>(using <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">xpath&#39;</span>,value <span style="color:#f92672">=</span> xpath)
    remDr<span style="color:#f92672">$</span><span style="color:#a6e22e">mouseMoveToLocation</span>(webElement<span style="color:#f92672">=</span>l)
    <span style="color:#75715e">#下载</span>
    remDr<span style="color:#f92672">$</span><span style="color:#a6e22e">click</span>()
    <span style="color:#75715e">#下载这儿强制5秒</span>
    <span style="color:#a6e22e">Sys.sleep</span>(<span style="color:#ae81ff">5</span>)
    <span style="color:#75715e">#下载文件路径</span>
    file <span style="color:#f92672">&lt;-</span> fs<span style="color:#f92672">::</span><span style="color:#a6e22e">dir_ls</span>(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">C:\\Users\\Liripo\\Downloads&#34;</span>,
                   type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">file&#34;</span>,regexp <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">gProfiler_hsapiens.+csv$&#34;</span>)
    <span style="color:#75715e">#文件重命名</span>
    <span style="color:#a6e22e">while</span>(rlang<span style="color:#f92672">::</span><span style="color:#a6e22e">is_empty</span>(file)){
        <span style="color:#75715e">#如果为空则重新点击下载</span>
        remDr<span style="color:#f92672">$</span><span style="color:#a6e22e">mouseMoveToLocation</span>(webElement<span style="color:#f92672">=</span>l)
        remDr<span style="color:#f92672">$</span><span style="color:#a6e22e">click</span>()
        file <span style="color:#f92672">&lt;-</span> fs<span style="color:#f92672">::</span><span style="color:#a6e22e">dir_ls</span>(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">C:\\Users\\Liripo\\Downloads&#34;</span>,
                           type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">file&#34;</span>,regexp <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">gProfiler_hsapiens.+csv$&#34;</span>)
    }
    <span style="color:#75715e">#重命名文件并移动</span>
    filename <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">paste</span>(tmp[[1]],tmp[[3]],<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">gprofiler&#34;</span>,sep <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">-&#34;</span>)
    <span style="color:#a6e22e">file_move</span>(path <span style="color:#f92672">=</span> file,
            new_path <span style="color:#f92672">=</span> <span style="color:#a6e22e">paste0</span>(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">G:\\liripo\\Rwork\\20200622-clusterresult\\&#34;</span>,
                            filename,<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">.csv&#34;</span>))
}
<span style="color:#a6e22e">lapply</span>(txt<span style="color:#f92672">$</span>url2[1<span style="color:#f92672">:</span><span style="color:#ae81ff">5</span>],getgprofiler)
</code></pre></div>
      </main>

      <div id="fastSearch">
   <input id="searchInput" tabindex="0">
   <ul id="searchResults">
   </ul>
</div>
<footer>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/highlight.min.js"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/languages/r.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/languages/python.min.js"></script>
  <script src ="/js/search.js"></script>
  <script src="../../js/fuse.js"></script> 
 <script src="../../js/fastsearch.js"></script>

  <script>
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  </script>
  
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <span id="busuanzi_container_site_pv">本站总访问量<span id       ="busuanzi_value_site_pv"></span>次</span>
  <br>
  <span >
    <mark>CMD+/</mark>对网站进行搜索
  </span>
  
  
<script async src="../../js/center-image.js"></script>
<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
<center>
Liripo <SPAN id=span_dt_dt style="color: #0196e3;"></SPAN>
<SCRIPT language=javascript>
function show_date_time(){
window.setTimeout("show_date_time()", 1000);
BirthDay=new Date("7/8/2019 00:00:00");
today=new Date();
timeold=(today.getTime()-BirthDay.getTime());
sectimeold=timeold/1000
secondsold=Math.floor(sectimeold);
msPerDay=24*60*60*1000
e_daysold=timeold/msPerDay
daysold=Math.floor(e_daysold);
e_hrsold=(e_daysold-daysold)*24;
hrsold=Math.floor(e_hrsold);
e_minsold=(e_hrsold-hrsold)*60;
minsold=Math.floor((e_hrsold-hrsold)*60);
seconds=Math.floor((e_minsold-minsold)*60);
span_dt_dt.innerHTML=""+daysold+"天"+hrsold+"小时"+minsold+"分"+seconds+"秒";
}
show_date_time();
</SCRIPT>
</center>
  
</footer>


    </div>
  </body>
</html>
