<!DOCTYPE html>
<html lang="Zh-cn">

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
    <title> | Liripo</title>
    <link rel="shortcut icon" href="../image/title.svg" type="image/x-icon">
  <script src="../fontawesome-free-5.11.2-web/fontawesome-free-5.11.2-web/js/all.js" crossorigin="anonymous"></script>

  <style>
  	:root {
  		--pagecolour: #333333;
  		--maintext: #dddddd;
  		--faded: #888888;
  		--highlight: #6BB0DF;
  		--lowlight: #ba68c8;
	}
  </style>
  <link rel="stylesheet" href="../css/et_book.css" />
  <link rel="stylesheet" href="../css/search.css" />
  <link rel="stylesheet" href="../css/style.css" />
  <link rel="alternate" type="application/rss+xml" href="https://liripo.github.io/index.xml" title="Liripo">
  
  <link rel="stylesheet" href="https://fonts.loli.net/css?family=Tangerine">

  
<meta name="twitter:card" content="summary">
<meta property="og:title" content="">




</head>


  <body>
    



    <div class="main-content">
      <nav>
  <ul class="menu">
    
    <li><a href="../">Home</a></li>
    
    <li><a href="../about/">About</a></li>
    
    <li><a href="../post/">Posts</a></li>
    
    <li><a href="../tags/">Tags</a></li>
    
  </ul>
</nav>

      <div>
  <h1></h1>
  <h3>
    
  </h3>
   <h5 id="wc">186 Words|Read in about 1       Min|本文总阅读量<span id="busuanzi_value_page_pv"></span>次</h5>
    </h5>
  <br><br>
</div>


      <main>
        

        <p>Postgresql</p>
<h1 id="heading">安装</h1>
<p>windows，官网下载即可。</p>
<p>linux,</p>
<h1 id="heading-1">创建数据库，用户</h1>
<p>sql语句以==；==结尾,一开始可以使用psql -U postgres进入初始的超级用户</p>
<p>生成新数据库<code>CREATE DATABASE mypsql;</code></p>
<p>创建用户<code> CREATE USER liripo WITH PASSWORD '123456';</code>密码需加引号。</p>
<p>赋予权限<code>GRANT ALL PRIVILEGES ON DATABASE mysql TO liripo;</code></p>
<p>之后即可使用<code>psql -U liripo -d mypsql -h localhost -p 5432</code>登录。</p>
<h1 id="r">使用R语言与数据库连接</h1>
<blockquote>
<p>使用SQL语句查询数据。</p>
</blockquote>
<p>使用三个R包<code>dplyr</code>,<code>DBI</code>,<code>odbc</code>以及<code>RPostgreSQL</code>连接postgresql</p>
<p><a href="https://db.rstudio.com/">教程</a></p>
<p>连接数据库，默认端口，host与shell中psql命令一致。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-R" data-lang="R">mypsql <span style="color:#f92672">&lt;-</span> DBI<span style="color:#f92672">::</span><span style="color:#a6e22e">dbConnect</span>(RPostgreSQL<span style="color:#f92672">::</span><span style="color:#a6e22e">PostgreSQL</span>(), 
               dbname <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">mypsql&#34;</span>,
               user <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">liripo&#34;</span>,
               password <span style="color:#f92672">=</span> rstudioapi<span style="color:#f92672">::</span><span style="color:#a6e22e">askForPassword</span>(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Database password&#34;</span>)
)
</code></pre></div><p>返回一个s4对象；考虑到安全性，Rstudio使用其api端口键入密码。【永远不要将其记录在分析脚本中或在控制台中键入密码。】</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-R" data-lang="R"><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">dbListTables</span>(mypsql)
<span style="color:#a6e22e">character</span>(<span style="color:#ae81ff">0</span>)
</code></pre></div><p>可以看到数据库中还没有表，使用最常用的mtcars数据</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-R" data-lang="R"><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">dbWriteTable</span>(mypsql,<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">mtcars&#34;</span>, mtcars)
[1] <span style="color:#66d9ef">TRUE</span>
<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">dbListTables</span>(mypsql)
[1] <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">mtcars&#34;</span>
<span style="color:#f92672">&gt;</span>res <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">dbSendQuery</span>(mypsql, <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">SELECT * FROM mtcars&#34;</span>)
<span style="color:#f92672">&gt;</span>res_df <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">dbFetch</span>(res)<span style="color:#75715e">#返回数据框</span>
<span style="color:#75715e">#返回后记得清除缓存</span>
<span style="color:#f92672">&gt;</span>dbClearResult（res）<span style="color:#75715e">#避免浪费资源的关键步骤</span>
<span style="color:#75715e">#数据集过大应一块块获取。</span>
<span style="color:#a6e22e">dbGetQuery</span>()为上述三个获取数据的整合。
</code></pre></div><p>试试检索数据耗时，==注：这里有无意义不清楚，而且数据量太小。==</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-R" data-lang="R"><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">system.time</span>(res <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">dbSendQuery</span>(mypsql, <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">SELECT * FROM mtcars WHERE cyl = 4&#34;</span>))
用户 系统 流逝 
   <span style="color:#ae81ff">0</span>    <span style="color:#ae81ff">0</span>    <span style="color:#ae81ff">0</span> 
<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">system.time</span>(<span style="color:#a6e22e">filter</span>(mtcars,cyl<span style="color:#f92672">==</span><span style="color:#ae81ff">4</span>)<span style="color:#f92672">%&gt;%</span><span style="color:#a6e22e">select</span>(<span style="color:#a6e22e">everything</span>()))
用户 系统 流逝 
<span style="color:#ae81ff">0.01</span> <span style="color:#ae81ff">0.00</span> <span style="color:#ae81ff">0.08</span> 
</code></pre></div><p>试着用266M的数据测试，耗时分别为</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-R" data-lang="R"><span style="color:#75715e">#有一点需注意，我使用的文件列数为56,203列，在R中操作列远没有行快。不知道数据库如何，还是作一番比较试试。</span>

</code></pre></div><p>试试进入数据库操作<code> SELECT * FROM mtcars;</code>确实已经有这个表了。</p>
<p>odbc包可用于Rstudio连接数据库，在Rstudio访问数据库。</p>
<p>下载postgresql的windows<a href="https://www.postgresql.org/ftp/odbc/versions/msi/">odbc</a>驱动</p>
<p>暂时没配置好，影响的是连接到数据库的速度。相较RPostgreSQL五到六倍??。</p>
<p><strong>交互</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-R" data-lang="R">cyl_code <span style="color:#f92672">&lt;-</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">4&#34;</span>
<span style="color:#a6e22e">dbGetQuery</span>(mypsql, <span style="color:#a6e22e">paste0</span>(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">SELECT * FROM mtcars WHERE cyl = &#39;&#34;</span>, cyl_code ,<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&#39;&#34;</span>))
<span style="color:#75715e">#上面的cyl_code就可以自由修改了呢。</span>
</code></pre></div><p>但是又引发一个问题，故意写成<code>4 ;DROP TABLE mtcars</code>不就会删除数据库表了么。gg</p>
<p>修改成参数化查询。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-R" data-lang="R">cyl <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">dbSendQuery</span>(con, <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">SELECT * FROM mtcars WHERE cyl = ?&#34;</span>)
<span style="color:#a6e22e">dbBind</span>(cyl, <span style="color:#a6e22e">list</span>(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">4&#34;</span>)) <span style="color:#75715e">#使用dbBind()特定值执行查询</span>
<span style="color:#a6e22e">dbFetch</span>(cyl)
<span style="color:#a6e22e">dbClearResult</span>(cyl)
<span style="color:#75715e">#所以一步到位dbGetQuery有分险</span>
</code></pre></div><p>使用dplyr操作数据库？？dbplyr自动转化R代码为SQL语句？？不需载入dbplyr,看到使用数据库自动载入？？</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-R" data-lang="R"><span style="color:#a6e22e">library</span>(dplyr)
airline_list <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">tbl</span>(con, <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">airlines&#34;</span>) <span style="color:#f92672">%&gt;%</span>
  collect  <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">split</span>(.$name) <span style="color:#f92672">%&gt;%</span>    <span style="color:#75715e"># Field that will be used for the labels</span>
  <span style="color:#a6e22e">map</span>(<span style="color:#f92672">~</span>.$carrier)      <span style="color:#75715e"># Field that will be used for keys</span>
</code></pre></div>
      </main>

      <div id="fastSearch">
   <input id="searchInput" tabindex="0">
   <ul id="searchResults">
   </ul>
</div>
<footer>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/highlight.min.js"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/languages/r.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/languages/python.min.js"></script>
  <script src ="/js/search.js"></script>
  <script src="../js/fuse.js"></script> 
 <script src="../js/fastsearch.js"></script>

  <script>
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  </script>
  
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <span id="busuanzi_container_site_pv">本站总访问量<span id       ="busuanzi_value_site_pv"></span>次</span>
  <br>
  <span >
    <mark>CMD+/</mark>对网站进行搜索
  </span>
  
  
<script async src="../js/center-image.js"></script>
<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
<center>
Liripo <SPAN id=span_dt_dt style="color: #0196e3;"></SPAN>
<SCRIPT language=javascript>
function show_date_time(){
window.setTimeout("show_date_time()", 1000);
BirthDay=new Date("7/8/2019 00:00:00");
today=new Date();
timeold=(today.getTime()-BirthDay.getTime());
sectimeold=timeold/1000
secondsold=Math.floor(sectimeold);
msPerDay=24*60*60*1000
e_daysold=timeold/msPerDay
daysold=Math.floor(e_daysold);
e_hrsold=(e_daysold-daysold)*24;
hrsold=Math.floor(e_hrsold);
e_minsold=(e_hrsold-hrsold)*60;
minsold=Math.floor((e_hrsold-hrsold)*60);
seconds=Math.floor((e_minsold-minsold)*60);
span_dt_dt.innerHTML=""+daysold+"天"+hrsold+"小时"+minsold+"分"+seconds+"秒";
}
show_date_time();
</SCRIPT>
</center>
  
</footer>


    </div>
  </body>
</html>
